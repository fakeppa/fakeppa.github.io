---
icon: pen-to-square
date: 2025-01-03
tags: 
title: Cè¯­è¨€
category:
  - å½’æ¡£
---
**å­¦C**
è¿™æ˜¯Cç¨‹åºç¼–è¯‘åçš„å†…å­˜çš„ç»“æ„
```bash
é«˜åœ°å€ (0x7fffffffffff)
+------------------------------+
|                              |  å†…æ ¸ç©ºé—´ (Kernel Space)
|                              |  (ç”¨æˆ·ç¨‹åºä¸å¯è®¿é—®)
+------------------------------+  <-- 0x7fffffffffff (1<<47 -1)
|           ...                |
|   ç¯å¢ƒå˜é‡ (Environment vars)  |
|   å‘½ä»¤è¡Œå‚æ•° (Command-line args)|  æ ˆé¡¶ (åˆå§‹æ—¶)
|                              |
+------------------------------+  <-- æ ˆé¡¶ (Stack Pointer, RSP) å‘ä¸‹å¢é•¿
|           Stack              |
|           (å‘ä¸‹å¢é•¿ â†“)         |
|                              |
|           ...                |
|                              |
+------------------------------+
|           ...                |
|           ...                |  æœªæ˜ å°„åŒºåŸŸ (Hole / Guard Page)
+------------------------------+
|                              |
|           Heap               |
|           (å‘ä¸Šå¢é•¿ â†‘)         |
|                              |
+------------------------------+  <-- å †åº• (Break, brk/sbrk ç®¡ç†)
|           .bss               |  (æœªåˆå§‹åŒ–/é›¶åˆå§‹åŒ–å…¨å±€/é™æ€å˜é‡)
+------------------------------+
|           .data              |  (åˆå§‹åŒ–éé›¶å…¨å±€/é™æ€å˜é‡)
+------------------------------+
|           .rodata            |  (åªè¯»æ•°æ®, å¦‚å­—ç¬¦ä¸²å¸¸é‡) [å¯èƒ½åˆå¹¶åˆ° .text]
+------------------------------+
|           .text              |  (ç¨‹åºä»£ç , åªè¯»)
+------------------------------+
|   ç¨‹åºå¤´éƒ¨ç­‰ (ELF Header)      |  ä½åœ°å€ (0x400000 é™„è¿‘)
+------------------------------+
```
.text  æ˜¯å¯æ‰§è¡Œä»£ç å­˜æ”¾çš„ä½ç½®ï¼Œ
.rodata æ˜¯å¸¸é‡éƒ¨åˆ†ï¼Œå¦‚å­—ç¬¦ä¸²çš„å€¼
.data åˆå§‹åŒ–çš„éé›¶ï¼Œå­˜å‚¨äº†é”®å€¼å¯¹çš„å†…å­˜æ®µ
.bss å€¼ä¸º0çš„å˜é‡åŒºåŸŸï¼Œå­˜å‚¨äº†é”®
  Heap  å’Œ stackä¸å¿…å¤šè¯´

## ä»ç¨‹åºè°ƒç”¨è§’åº¦ç†è§£å†…å­˜å—çš„åè°ƒé…åˆ
ç¨‹åºè°ƒç”¨è¿‡ç¨‹ä¸­çš„å†…å­˜å›¾è§£
```bash
é«˜åœ°å€ (0x7fffffffffff)
+---------------------------------------+ 
|               å†…æ ¸ç©ºé—´                 | 
+---------------------------------------+ <-- 0x7fffffffffff
|                                       |
|             è°ƒç”¨è€…æ ˆå¸§ (Caller)        |
|              (Caller's Frame)         |
|                                       |
|  +---------------------------------+  |
|  | è°ƒç”¨è€…å±€éƒ¨å˜é‡ (Caller's Locals)  |  | <-- è°ƒç”¨è€…EBP (Caller's EBP)
|  +---------------------------------+  |
|  | å‚æ•°åŒºåŸŸ (Parameters Area)       |  |
|  +---------------------------------+  |
|                                       | 
+=======================================+ <-- è°ƒç”¨è€…æ ˆé¡¶ (Caller's ESP before call)
|             å‡½æ•°è°ƒç”¨è¿‡ç¨‹               |
|              (Function Call)          |
+---------------------------------------+ 
|                                       | 
|             è¢«è°ƒç”¨å‡½æ•°æ ˆå¸§             |
|              (Callee Frame)           |
|                                       |
|  +---------------------------------+  | 
|  | å‚æ•°2 (Param2)                  |  | <-- [EBP + 12] 
|  +---------------------------------+  | 
|  | å‚æ•°1 (Param1)                  |  | <-- [EBP + 8]
|  +---------------------------------+  | 
|  | è¿”å›åœ°å€ (Return Address)        |  | <-- [EBP + 4]
|  +---------------------------------+  | 
|  | ä¿å­˜çš„EBP (Saved EBP)            |  | <-- EBP å½“å‰æŒ‡å‘è¿™é‡Œ â˜…
|  +---------------------------------+  | 
|  | å±€éƒ¨å˜é‡1 (Local Var1)           |  | <-- [EBP - 4]
|  +---------------------------------+  | 
|  | å±€éƒ¨å˜é‡2 (Local Var2)           |  | <-- [EBP - 8]
|  +---------------------------------+  | 
|  | ... (å…¶ä»–å±€éƒ¨å˜é‡)               |  | <-- ESP å½“å‰æŒ‡å‘è¿™é‡Œ
|  +---------------------------------+  | 
|                                       | 
+=======================================+ <-- æ ˆå½“å‰é¡¶éƒ¨ (Current ESP)
|             æœªä½¿ç”¨æ ˆç©ºé—´               |
|              (Free Stack Space)        |
|                                       | 
+---------------------------------------+
|             å † (Heap)                 |
|              (å‘ä¸Šå¢é•¿ â†‘)               |
+---------------------------------------+
|              .bss / .data / .rodata   |
+---------------------------------------+
|              .text (ä»£ç æ®µ)            |
+---------------------------------------+
ä½åœ°å€ (0x400000)
```
### ğŸ“Œ â€‹**â€‹å‡½æ•°è°ƒç”¨æµç¨‹ï¼šâ€‹**â€‹

1. 
    â€‹**â€‹è°ƒç”¨ (`call func`):â€‹**â€‹
    â†’ å‹å…¥è¿”å›åœ°å€ï¼Œè·³è½¬è‡³Â `func`ä»£ç ã€‚
2. 
    â€‹**â€‹å»ºç«‹æ–°æ ˆå¸§ (åºè¨€):â€‹**â€‹
    â†’Â `push ebp`(ä¿å­˜è°ƒç”¨è€…æ ˆåº•)
    â†’Â `mov ebp, esp`(è®¾ç½®å½“å‰æ ˆåº•)
    â†’Â `sub esp, N`(ä¸ºå±€éƒ¨å˜é‡è…¾ç©ºé—´)ã€‚
3. 
    â€‹**â€‹æ‰§è¡Œå‡½æ•°ä½“:â€‹**â€‹
    â†’ ç”¨Â `[ebp + offset]`è®¿é—®å‚æ•°
    â†’ ç”¨Â `[ebp - offset]`è®¿é—®å±€éƒ¨å˜é‡
    â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆ.text æŒ‡ä»¤ï¼‰ã€‚
4. 
    â€‹**â€‹æ‹†é™¤æ ˆå¸§ (å°¾å£°):â€‹**â€‹
    â†’Â `mov esp, ebp`(ä¸¢å¼ƒå±€éƒ¨å˜é‡)
    â†’Â `pop ebp`(æ¢å¤è°ƒç”¨è€…æ ˆåº•)
    â†’Â `ret`(å¼¹å‡ºè¿”å›åœ°å€ï¼Œè·³å›è°ƒç”¨å¤„)ã€‚

### æ³¨æ„
- å‚æ•°å’Œå±€éƒ¨å˜é‡ä¸­é—´å¤¹ç€è¿”å›åœ°å€ï¼Œæ„å‘³ç€å½“è¿”å›åœ°å€è¢«å¼¹å‡ºåï¼Œå‚æ•°è¿˜ç•™åœ¨æ ˆä¸Šï¼Œéœ€è¦æ‰‹åŠ¨æ¸…ç†

## æ ˆæº¢å‡º
32ä½ç³»ç»Ÿç¤ºä¾‹ï¼š
- `char buffer[32]`â†’ 32å­—èŠ‚
- EBPæŒ‡é’ˆ â†’ 4å­—èŠ‚
- æ€»åç§» = 32 + 4 = 36å­—èŠ‚
64ä½ç³»ç»Ÿç¤ºä¾‹ï¼š
- `char buffer[32]`â†’ 32å­—èŠ‚
- RBPæŒ‡é’ˆ â†’ 8å­—èŠ‚
- æ€»åç§» = 32 + 8 = 40å­—èŠ‚