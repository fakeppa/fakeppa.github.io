---
icon: pen-to-square
date: 2025-01-03
tags: 
title: Cè¯­è¨€
category:
  - å½’æ¡£
---
**å­¦C**
## **Windows æ“ä½œç³»ç»Ÿæ¶æ„åŸºç¡€â€‹**

### å…³äºåŠ¨æ€çš„ï¼Œæ“ä½œç³»ç»Ÿç”Ÿæˆçš„ï¼Œç”¨äºæè¿°è¿›ç¨‹çš„æ•°æ®ç»“æ„--PEBå’ŒTEB

PEB/TEBåœ¨å†…å­˜ä¸­çš„ä½ç½®
```bash
é«˜åœ°å€ (0x7FFFFFFF)  // 32ä½è¿›ç¨‹ç¤ºä¾‹
+---------------------------------------+ ----
|                                       |  ^
|               å†…æ ¸ç©ºé—´                 |  |  // ç¦æ­¢è®¿é—® (Inaccessible)
|                                       |  |
+=======================================+ <--- ç”¨æˆ·/å†…æ ¸ç©ºé—´åˆ†ç•Œçº¿ (e.g., 0x80000000)
|                                       |  |
|        ç”¨æˆ·ç©ºé—´å…±äº«æ•°æ®é¡µ              |  |  // æ‰€æœ‰è¿›ç¨‹å…±äº«çš„åªè¯»æ•°æ®ï¼Œå¦‚ç³»ç»Ÿæ—¶é—´ã€æ€§èƒ½è®¡æ•°å™¨
|    (KUSER_SHARED_DATA, å›ºå®šåœ°å€)        |  |
|                                       |  |
+---------------------------------------+  |
|                                       |  |
|                æ ˆ (Stack)             |  |  // ç”¨äºå‡½æ•°è°ƒç”¨ï¼Œå‘ä¸‹å¢é•¿ (â†“)
|                 (â†“ grows down)         |  |
|                                       |  |      +-----------------------+
|                                       |  |      |        TEB            |
+---------------------------------------+  |      +-----------------------+
|                 TEB æ•°ç»„               |  |      | - Stack Base (æ ˆåº•)   | // çº¿ç¨‹çš„æ ˆä¿¡æ¯åœ¨è¿™é‡Œ
|   (TEB for additional threads, if any)|  |      | - Stack Limit (æ ˆé¡¶)  |
|                                       |  |      | - Ptr to PEB          | ---+
+---------------------------------------+  |      | - Thread ID           |    |
|                ç¯å¢ƒå—                  |  |      | - LastError Value     |    |
|     (Process Environment Block, PEB)  |  |      +-----------------------+    |
|                                       |  |                                  |
|  +---------------------------------+  |  |      +-----------------------+   |
|  | PEB Contents:                   |  |  |      |        PEB            |   |
|  | - ImageBaseAddress (exe addr)   |  |  |      +-----------------------+   |
|  | - Ldr (Ptr to ---+--> PEB_LDR_DATA)|  |      | - ImageBaseAddress    |   |
|  | - ProcessParameters (CmdLine, EnvVars)| |      | - Ldr (Module Lists)  |   |
|  | - ...                          |  |  |      | - ProcessParameters   |   |
|  +---------------------------------+  |  |      | - ...                 |   |
|                                       |  |      +-----------------------+   |
+---------------------------------------+  |                                  |
|                å † (Heap)              |  |                                  |
|    (é»˜è®¤è¿›ç¨‹å † + å¯é€‰ç§æœ‰å †, â†‘ grows up)  |  |                                  |
|                                       |  |                                  |
+---------------------------------------+  |                                  |
|        å…¶ä»–å†…å­˜æ˜ å°„æ–‡ä»¶/åŒºåŸŸ            |  |  // ä¾‹å¦‚ï¼šé¢å¤–çš„DLLã€å†…å­˜æ˜ å°„æ–‡ä»¶      |
|   (Memory Mapped Files, e.g., DLLs)    |  |                                  |
|                                       |  |                                  |
+---------------------------------------+  |                                  |
|              PE æ˜ åƒ (exe)            |  |  // æ‚¨çš„ä¸»ç¨‹åº.exeæ–‡ä»¶è¢«æ˜ å°„åˆ°è¿™é‡Œ     |
|   (Mapped Executable Image, .exe)     |  |  +----------------------------+  |
|                                       |  |  | .text (Code, RX)          |  |
|  +---------------------------------+  |  |  | .data (Init Data, RW)    |  |
|  | .text (Code, RX)               |  |  |  | .rdata (Const Data, R)    |  |
|  | .data (Init Data, RW)          |  |  |  | .idata (Import Table, R)  |  | // **å…³é”®ï¼šå¯¼å…¥è¡¨åœ¨è¿™é‡Œ**
|  | .rdata (Const Data, R)         |  |  |  | .reloc (Relocations, R)   |  | // **å…³é”®ï¼šé‡å®šä½è¡¨åœ¨è¿™é‡Œ**
|  | .idata (Import Table, R)       |  |  |  | ...                       |  |
|  | .reloc (Relocations, R)        |  |  |  +----------------------------+  |
|  | ...                            |  |  |                                  |
|  +---------------------------------+  |  |                                  |
|                                       |  |                                  |
+---------------------------------------+  |                                  |
|              PE æ˜ åƒ (DLLs)           |  |  // æ‰€æœ‰ä¾èµ–çš„DLLï¼ˆå¦‚kernel32.dllï¼‰   |
|    (Mapped DLL Images, .dlls)         |  |  ä¹Ÿè¢«æ˜ å°„åˆ°ç±»ä¼¼çš„åŒºåŸŸï¼Œåœ°å€éšæœºåŒ–ï¼ˆASLRï¼‰|
|                                       |  |                                  |
|  +---------------------------------+  |  |                                  |
|  | .text (Code, RX)               |  |  |                                  |
|  | .data (Init Data, RW)          |  |  |                                  |
|  | .rdata (Const Data, R)         |  |  |                                  |
|  | .edata (Export Table, R)       |  |  |  // **å…³é”®ï¼šå¯¼å‡ºè¡¨åœ¨è¿™é‡Œ**           |
|  | ...                            |  |  |                                  |
|  +---------------------------------+  |  |                                  |
|                                       |  v
+---------------------------------------+ ----
ä½åœ°å€ (0x00010000)  // é€šå¸¸ä»0x10000å¼€å§‹ä»¥é¿å…ç©ºæŒ‡é’ˆè®¿é—®
```



è¿™æ˜¯Cç¨‹åºç¼–è¯‘åçš„å†…å­˜çš„ç»“æ„
```bash
é«˜åœ°å€ (0x7fffffffffff)
+------------------------------+
|                              |  å†…æ ¸ç©ºé—´ (Kernel Space)
|                              |  (ç”¨æˆ·ç¨‹åºä¸å¯è®¿é—®)
+------------------------------+  <-- 0x7fffffffffff (1<<47 -1)
|           ...                |
|   ç¯å¢ƒå˜é‡ (Environment vars)  |
|   å‘½ä»¤è¡Œå‚æ•° (Command-line args)|  æ ˆé¡¶ (åˆå§‹æ—¶)
|                              |
+------------------------------+  <-- æ ˆé¡¶ (Stack Pointer, RSP) å‘ä¸‹å¢é•¿
|           Stack              |
|           (å‘ä¸‹å¢é•¿ â†“)         |
|                              |
|           ...                |
|                              |
+------------------------------+
|           ...                |
|           ...                |  æœªæ˜ å°„åŒºåŸŸ (Hole / Guard Page)
+------------------------------+
|                              |
|           Heap               |
|           (å‘ä¸Šå¢é•¿ â†‘)         |
|                              |
+------------------------------+  <-- å †åº• (Break, brk/sbrk ç®¡ç†)
|           .bss               |  (æœªåˆå§‹åŒ–/é›¶åˆå§‹åŒ–å…¨å±€/é™æ€å˜é‡)
+------------------------------+
|           .data              |  (åˆå§‹åŒ–éé›¶å…¨å±€/é™æ€å˜é‡)
+------------------------------+
|           .rodata            |  (åªè¯»æ•°æ®, å¦‚å­—ç¬¦ä¸²å¸¸é‡) [å¯èƒ½åˆå¹¶åˆ° .text]
+------------------------------+
|           .text              |  (ç¨‹åºä»£ç , åªè¯»)
+------------------------------+
|ç¨‹åºå¤´éƒ¨ç­‰ (ELF Header)LINUXç³»ç»Ÿ|  ä½åœ°å€ (0x400000 é™„è¿‘)
+------------------------------+
```
.text  æ˜¯å¯æ‰§è¡Œä»£ç å­˜æ”¾çš„ä½ç½®ï¼Œ
.rodata æ˜¯å¸¸é‡éƒ¨åˆ†ï¼Œå¦‚å­—ç¬¦ä¸²çš„å€¼
.data åˆå§‹åŒ–çš„éé›¶ï¼Œå­˜å‚¨äº†é”®å€¼å¯¹çš„å†…å­˜æ®µ
.bss å€¼ä¸º0çš„å˜é‡åŒºåŸŸï¼Œå­˜å‚¨äº†é”®
  Heap  å’Œ stackä¸å¿…å¤šè¯´

## ä»ç¨‹åºè°ƒç”¨è§’åº¦ç†è§£å†…å­˜å—çš„åè°ƒé…åˆ
ç¨‹åºè°ƒç”¨è¿‡ç¨‹ä¸­çš„å†…å­˜å›¾è§£
```bash
é«˜åœ°å€ (0x7fffffffffff)
+---------------------------------------+ 
|               å†…æ ¸ç©ºé—´                 | 
+---------------------------------------+ <-- 0x7fffffffffff
|                                       |
|             è°ƒç”¨è€…æ ˆå¸§ (Caller)        |
|              (Caller's Frame)         |
|                                       |
|  +---------------------------------+  |
|  | è°ƒç”¨è€…å±€éƒ¨å˜é‡ (Caller's Locals)  |  | <-- è°ƒç”¨è€…EBP (Caller's EBP)
|  +---------------------------------+  |
|  | å‚æ•°åŒºåŸŸ (Parameters Area)       |  |
|  +---------------------------------+  |
|                                       | 
+=======================================+ <-- è°ƒç”¨è€…æ ˆé¡¶ (Caller's ESP before call)
|             å‡½æ•°è°ƒç”¨è¿‡ç¨‹               |
|              (Function Call)          |
+---------------------------------------+ 
|                                       | 
|             è¢«è°ƒç”¨å‡½æ•°æ ˆå¸§             |
|              (Callee Frame)           |
|                                       |
|  +---------------------------------+  | 
|  | å‚æ•°2 (Param2)                  |  | <-- [EBP + 12] 
|  +---------------------------------+  | 
|  | å‚æ•°1 (Param1)                  |  | <-- [EBP + 8]
|  +---------------------------------+  | 
|  | è¿”å›åœ°å€ (Return Address)        |  | <-- [EBP + 4]
|  +---------------------------------+  | 
|  | ä¿å­˜çš„EBP (Saved EBP)            |  | <-- EBP å½“å‰æŒ‡å‘è¿™é‡Œ â˜…
|  +---------------------------------+  | 
|  | å±€éƒ¨å˜é‡1 (Local Var1)           |  | <-- [EBP - 4]
|  +---------------------------------+  | 
|  | å±€éƒ¨å˜é‡2 (Local Var2)           |  | <-- [EBP - 8]
|  +---------------------------------+  | 
|  | ... (å…¶ä»–å±€éƒ¨å˜é‡)               |  | <-- ESP å½“å‰æŒ‡å‘è¿™é‡Œ
|  +---------------------------------+  | 
|                                       | 
+=======================================+ <-- æ ˆå½“å‰é¡¶éƒ¨ (Current ESP)
|             æœªä½¿ç”¨æ ˆç©ºé—´               |
|              (Free Stack Space)        |
|                                       | 
+---------------------------------------+
|             å † (Heap)                 |
|              (å‘ä¸Šå¢é•¿ â†‘)               |
+---------------------------------------+
|              .bss / .data / .rodata   |
+---------------------------------------+
|              .text (ä»£ç æ®µ)            |
+---------------------------------------+
ä½åœ°å€ (0x400000)
```
### ğŸ“Œ â€‹**â€‹å‡½æ•°è°ƒç”¨æµç¨‹(linux)ï¼šâ€‹**â€‹

1. 
    â€‹**â€‹è°ƒç”¨ (`call func`):â€‹**â€‹
    â†’ å‹å…¥è¿”å›åœ°å€ï¼Œè·³è½¬è‡³Â `func`ä»£ç ã€‚
2. 
    â€‹**â€‹å»ºç«‹æ–°æ ˆå¸§ (åºè¨€):â€‹**â€‹
    â†’Â `push ebp`(ä¿å­˜è°ƒç”¨è€…æ ˆåº•)
    â†’Â `mov ebp, esp`(è®¾ç½®å½“å‰æ ˆåº•)
    â†’Â `sub esp, N`(ä¸ºå±€éƒ¨å˜é‡è…¾ç©ºé—´)ã€‚
3. 
    â€‹**â€‹æ‰§è¡Œå‡½æ•°ä½“:â€‹**â€‹
    â†’ ç”¨Â `[ebp + offset]`è®¿é—®å‚æ•°
    â†’ ç”¨Â `[ebp - offset]`è®¿é—®å±€éƒ¨å˜é‡
    â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆ.text æŒ‡ä»¤ï¼‰ã€‚
4. 
    â€‹**â€‹æ‹†é™¤æ ˆå¸§ (å°¾å£°):â€‹**â€‹
    â†’Â `mov esp, ebp`(ä¸¢å¼ƒå±€éƒ¨å˜é‡)
    â†’Â `pop ebp`(æ¢å¤è°ƒç”¨è€…æ ˆåº•)
    â†’Â `ret`(å¼¹å‡ºè¿”å›åœ°å€ï¼Œè·³å›è°ƒç”¨å¤„)ã€‚

### æ³¨æ„
- å‚æ•°å’Œå±€éƒ¨å˜é‡ä¸­é—´å¤¹ç€è¿”å›åœ°å€ï¼Œæ„å‘³ç€å½“è¿”å›åœ°å€è¢«å¼¹å‡ºåï¼Œå‚æ•°è¿˜ç•™åœ¨æ ˆä¸Šï¼Œéœ€è¦æ‰‹åŠ¨æ¸…ç†

## æ ˆæº¢å‡º
32ä½ç³»ç»Ÿç¤ºä¾‹ï¼š
- `char buffer[32]`â†’ 32å­—èŠ‚
- EBPæŒ‡é’ˆ â†’ 4å­—èŠ‚
- æ€»åç§» = 32 + 4 = 36å­—èŠ‚
64ä½ç³»ç»Ÿç¤ºä¾‹ï¼š
- `char buffer[32]`â†’ 32å­—èŠ‚
- RBPæŒ‡é’ˆ â†’ 8å­—èŠ‚
- æ€»åç§» = 32 + 8 = 40å­—èŠ‚